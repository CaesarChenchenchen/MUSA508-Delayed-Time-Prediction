---
title: "Train Delay Time Prediction"
author: "Tianxiao & Ling"
date: "2023-11-25"
output: html_document
---

# Introduction

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load package}
library(tidycensus)
library(tidyverse)
library(dplyr)
library(sf)
library(ggplot2)
library(lubridate)
library(tigris)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(RSocrata)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(vtable)
library(gganimate)
library(gifski)
library(purrr)
library(geosphere)
library(googlesheets4)
library(corrplot)

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.2),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=10),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette6 <- c("#264653","#2a9d8f",'#8AB17D',"#e9c46a",'#f4a261',"#e76f51")
palette5 <- c("#264653","#2a9d8f","#e9c46a",'#f4a261',"#e76f51")
palette4 <- c("#264653","#2a9d8f","#e9c46a","#e76f51")
palette2 <- c("#264653","#2a9d8f")
```

#Data Wrangling
## NJ Transit Delay Data
## Weather Data
## Census Data
```{r load data}
#geometry data
line <- st_read('https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTRANSIT_RAIL_LINES_1/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson')%>%
  mutate(LINE_NAME = ifelse(LINE_NAME == 'Bergen County Line','Bergen Co. Line ',LINE_NAME),
         LINE_NAME = ifelse(LINE_NAME == 'Montclair-Boonton Line','Montclair-Boonton',LINE_NAME),
         LINE_NAME = ifelse(LINE_NAME == 'North Jersey Coast Line','No Jersey Coast',LINE_NAME),
         LINE_NAME = ifelse(LINE_NAME == 'Northeast Corridor','Northeast Corrdr',LINE_NAME),
         LINE_NAME = ifelse(LINE_NAME == 'Pascack Valley Line','Pascack Valley',LINE_NAME),
         LINE_NAME = ifelse(LINE_NAME == 'Princeton Dinky','Princeton Shuttle',LINE_NAME),
         LINE_NAME = ifelse(LINE_NAME == 'Raritan Valley Line','Raritan Valley',LINE_NAME))%>%
  dplyr::select(LINE_NAME,geometry)

stop <- st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Stations/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") %>%
  mutate(STATION_ID = ifelse(STATION_ID == 'Atlantic City', 'Atlantic City Rail Terminal', STATION_ID),
         STATION_ID = ifelse((STATION_ID == 'Middletown')&(COUNTY == 'Orange, NY'), 'Middletown NY', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Princeton Jct.', 'Princeton Junction', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Secaucus Junction Upper Level', 'Secaucus Upper Lvl', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Anderson Street-Hackensack', 'Anderson Street', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Bay Street-Montclair', 'Bay Street', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Broadway', 'Broadway Fair Lawn', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Essex Street-Hackensack', 'Essex Street', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Glen Rock-Boro Hall', 'Glen Rock Boro Hall', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Glen Rock-Main', 'Glen Rock Main Line', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Hoboken Terminal', 'Hoboken', STATION_ID),
         STATION_ID = ifelse((STATION_ID == 'Middletown')&(COUNTY == 'Monmouth'), 'Middletown NJ', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Montclair St Univ', 'Montclair State U', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Mountain View-Wayne', 'Mountain View', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Pennsauken Transit Center', 'Pennsauken', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Radburn', 'Radburn Fair Lawn', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Ramsey', 'Ramsey Main St', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Rte 17 Ramsey', 'Ramsey Route 17', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Secaucus Junction Lower Level', 'Secaucus Lower Lvl', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Teterboro-Williams Ave', 'Teterboro', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Watsessing', 'Watsessing Avenue', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Wayne Route 23 Transit Center', 'Wayne-Route 23', STATION_ID),
         STATION_ID = ifelse(STATION_ID == 'Wood-Ridge', 'Wood Ridge', STATION_ID),
         STATION_ID = ifelse(STATION_ID == '30th Street Station', 'Philadelphia', STATION_ID),
         line_intersct = str_count(RAIL_SERVICE, ",") + 1)%>%
  dplyr::select(STATION_ID,LATITUDE,LONGITUDE,line_intersct)%>%
  st_drop_geometry()

id <- '1V_kl3QKOxrTlwA8UG7kdv_VpJdaojKMj'
delay_df <- read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", id))%>%
  filter(type == 'NJ Transit')%>%
  na.omit()

merged_dataset <- merge(delay_df, stop, by.x = "from", by.y = "STATION_ID",all.x = TRUE)
merged_dataset <- merge(merged_dataset, stop, by.x = "to", by.y = "STATION_ID",all.x = TRUE)
merged_dataset <- merged_dataset%>%
  filter(to != 'Mount Arlington')%>%
  filter(from != 'Mount Arlington')%>%
  rename(from_lat = LATITUDE.x,
         from_lon = LONGITUDE.x,
         from_inter = line_intersct.x,
         to_lat = LATITUDE.y,
         to_lon = LONGITUDE.y,
         to_inter = line_intersct.y
         )%>%
  mutate(distance = distHaversine(cbind(from_lon, from_lat), cbind(to_lon, to_lat)),
         interval60 = floor_date(ymd_hms(scheduled_time), unit = "hour"),
         week = week(interval60),
         dotw = wday(interval60, label=TRUE),
         time_of_day = case_when(hour(interval60) < 7 | hour(interval60) > 19 ~ "Overnight",
                                 hour(interval60) >= 7 & hour(interval60) < 10 ~ "AM Rush",
                                 hour(interval60) >= 10 & hour(interval60) < 15 ~ "Mid-Day",
                                 hour(interval60) >= 15 & hour(interval60) <= 19 ~ "PM Rush"),
         weekend = ifelse(dotw %in% c("Sun", "Sat"), "Weekend", "Weekday"))

#wweather data
weather.Panel <- 
  riem_measures(station = "EWR", date_start = "2019-10-01", date_end = "2019-11-02") %>%
  dplyr::select(valid, tmpf, p01i, sknt)%>%
  replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))

# census data
NJCensus <- 
  get_acs(geography = "county subdivision", 
          variables = c("B01003_001", "B19013_001", 
                        "B02001_002", "B08013_001",
                        "B08012_001", "B08301_001", 
                        "B08301_010", "B01002_001"), 
          year = 2019, 
          state = "NJ", 
          geometry = TRUE, 
          output = "wide") %>%
  rename(Total_Pop =  B01003_001E,
         Med_Inc = B19013_001E,
         Med_Age = B01002_001E,
         White_Pop = B02001_002E,
         Travel_Time = B08013_001E,
         Num_Commuters = B08012_001E,
         Means_of_Transport = B08301_001E,
         Total_Public_Trans = B08301_010E) %>%
  select(Total_Pop, Med_Inc, White_Pop, Travel_Time,
         Means_of_Transport, Total_Public_Trans,
         Med_Age,
         GEOID, geometry) %>%
  mutate(Percent_White = White_Pop / Total_Pop,
         Mean_Commute_Time = Travel_Time / Total_Public_Trans,
         Percent_Taking_Public_Trans = Total_Public_Trans / Means_of_Transport)

NJCensus_select <- NJCensus%>%
  mutate(bigcity = ifelse(Total_Pop >= 100000, 'big city','small city'))%>%
  select(geometry, Total_Pop,bigcity, GEOID)

NJTracts <- 
  NJCensus %>%
  as.data.frame() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  select(GEOID, geometry) %>% 
  st_sf

train_census <- st_join(merged_dataset %>% 
          filter(is.na(from_lon) == FALSE &
                   is.na(from_lat) == FALSE &
                   is.na(to_lat) == FALSE &
                   is.na(to_lon) == FALSE) %>%
          st_as_sf(., coords = c("from_lon", "from_lat"), crs = 4326),
        NJTracts %>%
          st_transform(crs=4326),
        join=st_intersects,
              left = TRUE) %>%
  rename(From.Tract = GEOID) %>%
  mutate(from_lon = unlist(map(geometry, 1)),
         from_lat = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  select(-geometry)

train_census <- train_census %>%
  st_as_sf(., coords = c("to_lon", "to_lat"), crs = 4326) %>%
  st_join(., NJTracts %>%
            st_transform(crs=4326),
          join=st_intersects,
          left = TRUE) %>%
  rename(To.Tract = GEOID)  %>%
  mutate(to_lon = unlist(map(geometry, 1)),
         to_lat = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  select(-geometry)

train_dataset <-train_census  %>%
  left_join(weather.Panel, by ="interval60")

merged_dataset <- train_dataset  %>%
  left_join(NJCensus_select, by = c("From.Tract" = "GEOID")) %>%
  left_join(NJCensus_select, by =c("To.Tract"="GEOID")) %>%
  select(-geometry.x,-geometry.y) %>%
  rename(From_Total_Pop = Total_Pop.x,
         To_Total_Pop = Total_Pop.y,
         From_city = bigcity.x,
         To_city = bigcity.y)%>%
  mutate(From_Total_Pop = ifelse(from == "Philadelphia", 1579075, From_Total_Pop),
         To_Total_Pop = ifelse(to == "Philadelphia", 1579075, To_Total_Pop),
         From_Total_Pop = ifelse(from == "Middletown NY", 1631993, From_Total_Pop),
         To_Total_Pop = ifelse(to == "Middletown NY", 1631993, To_Total_Pop),
         From_city = ifelse(from == "Philadelphia", 'big city', From_city),
         To_city = ifelse(to == "Philadelphia", 'big city', To_city),
         From_city = ifelse(from == "Middletown NY", 'big city', From_city),
         To_city = ifelse(to == "Middletown NY", 'big city', To_city))

median_value_f <- median(merged_dataset$From_Total_Pop, na.rm = TRUE)
merged_dataset$From_Total_Pop[is.na(merged_dataset$From_Total_Pop)] <- median_value_f
median_value_t <- median(merged_dataset$To_Total_Pop, na.rm = TRUE)
merged_dataset$To_Total_Pop[is.na(merged_dataset$To_Total_Pop)] <- median_value_t

merged_dataset <- merged_dataset%>%
  mutate(From_city = ifelse(From_Total_Pop == 24784, 'big city', From_city),
         To_city = ifelse(To_Total_Pop == 24784, 'big city', To_city))
```

# Exploratory Analysis
## Serial Autocorrelation - Fixed Effects
```{r plot_weather, fig.height=6, fig.width=8,warning=FALSE}
grid.arrange(
  ggplot(weather.Panel, aes(interval60,Precipitation)) + geom_line(color="#264653") + 
  labs(title="Percipitation", x="Hour", y="Perecipitation") + plotTheme(),
  ggplot(weather.Panel, aes(interval60,Wind_Speed)) + geom_line(color="#264653") + 
    labs(title="Wind Speed", x="Hour", y="Wind Speed") + plotTheme(),
  ggplot(weather.Panel, aes(interval60,Temperature)) + geom_line(color="#264653") + 
    labs(title="Temperature", x="Hour", y="Temperature") + plotTheme(),
  top="Weather Data - NJ EWR - Nov, 2019")
```

From the Temporal Series Analysis, We can find that Delay in NJ Transit has an obvious regularity in the temporal field. We were able to find that weekend delays had a longer average length than weekdays. And when we look at latency over a 24-hour period, we can see that latency reaches its maximum between 2:00 a.m. and 3:00 a.m., and overall latency stays on an upward trend from 4:00 a.m. onwards. And when we look at the relationship between stop sequence and delay time, we are able to see that the average latency time increases as the station sequence increases. We were able to find the highest latency in the PM Rush phase, followed by the overnight phase. When we wanted to explore the compounding of time, we were able to find that the PM Rush phase and the overnight phase had significantly higher latency times on weekends than on weekdays. And when we look at the pattern of average delay times for 24 hours in a day compared to weekdays and weekends, we find that they both maintain a similar pattern.
```{r delay analysis}
delay_time <- merged_dataset %>%
  group_by(time_of_day)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_day <- merged_dataset %>%
  group_by(dotw)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_week <- merged_dataset %>%
  group_by(weekend)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_hour <- merged_dataset %>%
  group_by(hour(interval60))%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  rename(hour = 'hour(interval60)')

delay_sequence <- merged_dataset %>%
  group_by(stop_sequence)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_time_week <- merged_dataset %>%
  group_by(time_of_day,weekend)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_week_hour <- merged_dataset %>%
  group_by(weekend,hour(interval60))%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  rename(hour = 'hour(interval60)')

grid.arrange(ggplot(data = delay_day, aes(x = dotw, y = mean_delay)) +
  geom_bar(stat = "identity",fill = "#2a9d8f") +
  labs(title = "Delay minutes in a week", x = "Day of The Week", y = "Mean Delay") +
  theme_minimal(),
  ggplot(data = delay_week, aes(x = weekend, y = mean_delay)) +
  geom_bar(stat = "identity",fill = palette2) +
  labs(title = "Delay minutes comparison in weekday & weekend", x = "Weekend or Weekday", y = "Mean Delay") +
  theme_minimal(),
  ggplot(data = delay_hour, aes(x = hour, y = mean_delay)) +
  geom_bar(stat = "identity",fill = "#2a9d8f") +
  labs(title = "Delay minutes in 24 hours", x = "Hour in a day", y = "Mean Delay") +
  theme_minimal(),
  ggplot(data = delay_sequence, aes(x = stop_sequence, y = mean_delay)) +
  geom_bar(stat = "identity",fill = "#2a9d8f") +
  labs(title = "Delay minutes in each sequence", x = "Stop Sequence", y = "Mean Delay") +
  theme_minimal(),
  ggplot(data = delay_time, aes(x = time_of_day, y = mean_delay)) +
  geom_bar(stat = "identity",fill = "#2a9d8f") +
  labs(title = "Delay minutes in a week", x = "Day of The Week", y = "Mean Delay") +
  theme_minimal(),
  ggplot(data = delay_time_week, aes(x = time_of_day, y = mean_delay, fill = weekend)) +
  geom_col(position = "dodge")+
  labs(title = "Delay minutes comparison in weekday & weekend", x = "Weekend or Weekday", y = "Mean Delay") + 
  scale_fill_manual(values = palette2)+
  theme_minimal(),
  ggplot(data = delay_week_hour, aes(x = hour, y = mean_delay, color = weekend)) +
  geom_line() +
  scale_color_manual(values = palette2) +
  labs(title = "The delay under week and time", x = "Hour", y = "Delay Minutes") +
  theme_minimal(),nrow=3)
```

## Spatial Autocorrelation - Fixed Effects
```{r spatial analysis}
delay_line <- merged_dataset %>%
  group_by(line)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  arrange(., mean_delay)

delay_from <- merged_dataset %>%
  group_by(from)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  arrange(., -mean_delay)%>%
  head(20)

big_from <- merged_dataset %>%
  group_by(From_city)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  mutate(status = 'from')%>%
  rename(city_type = From_city)

big_to <- merged_dataset %>%
  group_by(To_city)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  mutate(status = 'to')%>%
  rename(city_type = To_city)

grid.arrange(ggplot(data = delay_line, aes(x = line, y = mean_delay, fill = line)) +
  geom_col(position = "dodge")+
  labs(title = "Delay minutes comparison in lines", x = "line", y = "Mean Delay") + 
  scale_colour_viridis(direction = -1,discrete = FALSE, option = "D")+
  theme_minimal(),
  ggplot(data = rbind(big_from,big_to), aes(x = status , y = mean_delay, fill = city_type)) +
  geom_col(position = "dodge")+
  labs(title = "Delay minutes comparison in big and small city", x = "City Type", y = "Mean Delay") + 
  scale_fill_manual(values = palette2)+
  theme_minimal())

ggplot(data = delay_from, aes(x = from, y = mean_delay, fill = from)) +
  geom_col(position = "dodge")+
  labs(title = "Delay minutes comparison in lines", x = "line", y = "Mean Delay") + 
  scale_colour_viridis(direction = -1,discrete = FALSE, option = "E")+
  theme_minimal()
```

```{r map visualization}
map_from <- merged_dataset %>%
  group_by(from)%>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  left_join(stop,by=c('from'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Orientation')%>%
  rename(station = from)

map_to <- merged_dataset %>%
  group_by(to)%>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  left_join(stop,by=c('to'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Destination')%>%
  rename(station = to)

ggplot() +
  geom_sf(data = NJTracts, color = 'grey') + 
  geom_sf(data = rbind(map_from,map_to), aes(size = mean_delay,color = mean_delay), alpha = 0.5) +
  scale_colour_viridis(direction = -1,discrete = FALSE, option = "D")+
  scale_size_continuous(name = "Delay Minutes") +
  coord_sf()+
  labs(title="Delayed Time in Station, October, 2019")+
  facet_grid(~status)+
  mapTheme()
```

## Space-time Autocorrelation
```{r delay analysis combine}
delay_stop_time <- merged_dataset %>%
  group_by(from,to,hour(interval60))%>%
  summarize(mean_delay = mean(delay_minutes))

delay_intersct_week_f <-merged_dataset %>%
  group_by(from_inter,weekend)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_intersct_week_t <-merged_dataset %>%
  group_by(to_inter,weekend)%>%
  summarize(mean_delay = mean(delay_minutes))
```

```{r}
inter_stop <- stop%>%
  right_join(delay_intersct_week_f,by=c('line_intersct' = 'from_inter'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)

ggplot() +
    geom_sf(data = NJTracts, color = 'grey') + 
    geom_sf(data = inter_stop, aes(size = line_intersct,color = mean_delay)) +
    scale_colour_viridis(direction = -1,discrete = FALSE, option = "D") +
    labs(title = "Station Delay For One Day in Oct, 2019",
         subtitle = "Hours in a day: {current_frame}") +
    facet_wrap(~weekend)+ mapTheme()
```

```{r station delay visulaization}
delay_to_time <- merged_dataset %>%
  group_by(to,hour(interval60))%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  rename(hour = 'hour(interval60)')%>%
  left_join(stop,by=c('to'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Orientation')%>%
  rename(station = to)

delay_from_time <- merged_dataset %>%
  group_by(from,hour(interval60))%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  rename(hour = 'hour(interval60)')%>%
  left_join(stop,by=c('from'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Destination')%>%
  rename(station = from)

ggplot() +
    geom_sf(data = NJTracts, color = 'grey') + 
    geom_sf(data = rbind(delay_from_time,delay_to_time), aes(size =mean_delay, color = mean_delay)) +
    scale_colour_viridis(direction = -1,discrete = FALSE, option = "D") +
    labs(title = "Station Delay For One Day in Oct, 2019",
         subtitle = "Hours in a day: {current_frame}") +
    facet_wrap(~status)+
    transition_manual(hour)+ mapTheme()
```

```{r}
delay_to_time <- merged_dataset %>%
  group_by(to,dotw)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  rename(Day = dotw)%>%
  left_join(stop,by=c('to'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Orientation')%>%
  rename(station = to)

delay_from_time <- merged_dataset %>%
  group_by(from,dotw)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  rename(Day = dotw)%>%
  left_join(stop,by=c('from'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Destination')%>%
  rename(station = from)

ggplot() +
    geom_sf(data = NJTracts, color = 'grey') + 
    geom_sf(data = rbind(delay_from_time,delay_to_time), aes(size =mean_delay, color = mean_delay)) +
    scale_colour_viridis(direction = -1,discrete = FALSE, option = "D") +
    labs(title = "Station Delay For One Week in Oct, 2019",
         subtitle = "Day in a week: {current_frame}") +
    facet_wrap(~status)+
    transition_manual(Day)+ mapTheme()
```

```{r}
delay_to_time <- merged_dataset %>%
  group_by(to,week)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  left_join(stop,by=c('to'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Orientation')%>%
  rename(station = to)

delay_from_time <- merged_dataset %>%
  group_by(from,week)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  left_join(stop,by=c('from'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  mutate(status = 'Destination')%>%
  rename(station = from)

ggplot() +
    geom_sf(data = NJTracts, color = 'grey') + 
    geom_sf(data = rbind(delay_from_time,delay_to_time), aes(size =mean_delay, color = mean_delay)) +
    scale_colour_viridis(direction = -1,discrete = FALSE, option = "D") +
    labs(title = "Station Delay For One Month in Oct, 2019",
         subtitle = "Week in a month: {current_frame}") +
    facet_wrap(~status)+
    transition_manual(week)+ mapTheme()
```

## Operation Effects
```{r}
delay_distance <- merged_dataset %>%
  group_by(distance)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_intersct <- rbind(
  merged_dataset %>%
  group_by(from_inter)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  mutate(status = 'from')%>%
  rename(inter = from_inter),
  merged_dataset %>%
  group_by(to_inter)%>%
  summarize(mean_delay = mean(delay_minutes))%>%
  mutate(status = 'to')%>%
  rename(inter = to_inter))

delay_rain_week <- merged_dataset %>%
  mutate(rain = ifelse(Precipitation == 0,'NoRain','Rain'))%>%
  group_by(rain,weekend)%>%
  summarize(mean_delay = mean(delay_minutes))

delay_temp <- merged_dataset %>%
  group_by(Temperature)%>%
  summarize(mean_delay = mean(delay_minutes))
# just calculate the intersecation delay
grid.arrange(
  ggplot(data = delay_intersct, aes(x = inter, y = mean_delay,fill=status)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = palette2) +
  labs(title = "Delay minutes in each intersection", x = "Num of Line", y = "Mean Delay") +
  theme_minimal(),
  ggplot(data = delay_rain_week, aes(x = rain, y = mean_delay,fill=weekend)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = palette2) +
  labs(title = "Delay minutes with Rain", x = "Rain", y = "Mean Delay") +
  theme_minimal(),
  ggplot(data = delay_distance, aes(x = distance, y = mean_delay)) +
  geom_line(color = "#2a9d8f") +
  labs(title = "The relationship between delay and distance", x = "Time", y = "Value") +
  geom_smooth(method = "lm", se = TRUE)+
  theme_minimal(),
  ggplot(data = delay_temp, aes(x = Temperature, y = mean_delay)) +
  geom_line(color = "#2a9d8f") +
  labs(title = "The relationship between delay and temperature", x = "Temperature", y = "Value") +
  geom_smooth(method = "lm", se = TRUE)+
  theme_minimal())
```

## Time Lag Effects
```{r time_lags,include=FALSE}
merged_dataset <- merged_dataset %>%
   mutate(interval15 = floor_date(ymd_hms(scheduled_time), unit = "15 mins"))

merged_dataset <- 
  merged_dataset %>% 
  arrange(from_id, interval15) %>% 
  mutate(lag15min = dplyr::lag(delay_minutes,1),
         lag30min = dplyr::lag(delay_minutes,2),
         lag45min = dplyr::lag(delay_minutes,3),
         lag1h = dplyr::lag(delay_minutes,4),
         lag1h15min = dplyr::lag(delay_minutes,5),
         lag1h30min = dplyr::lag(delay_minutes,6),
         lag1h45min = dplyr::lag(delay_minutes,7),
         lag2h = dplyr::lag(delay_minutes,8),
         lag2h15min = dplyr::lag(delay_minutes,9),
         lag2h30min = dplyr::lag(delay_minutes,10),
         lag2h45min = dplyr::lag(delay_minutes,11),
         lag3h = dplyr::lag(delay_minutes,12))
```

```{r evaluate_lags, echo=FALSE,warning=FALSE}
as.data.frame(merged_dataset) %>%
    group_by(interval15) %>% 
    summarise_at(vars(starts_with("lag"), "delay_minutes"), mean, na.rm = TRUE) %>%
    gather(Variable, Value, -interval15, -delay_minutes) %>%
    mutate(Variable = factor(Variable, levels=c("lag15min","lag30min","lag45min","lag1h",                       "lag1h15min","lag1h30min","lag1h45min","lag2h","lag2h15min","lag2h30min","lag2h45min","lag3h")))%>%
    group_by(Variable) %>%  
    summarize(correlation = round(cor(Value, delay_minutes),2))
```

###  NE线上n个station的lag：lag from the previous1/2/3/4/5/…station
```{r station_lags,include=FALSE}
merged_dataset_station <- 
  merged_dataset %>% 
  arrange(train_id, interval15,stop_sequence) %>% 
  mutate(lagsstation = if_else(stop_sequence == 1, 0, lag(delay_minutes, 1)),
         lags2station = if_else(stop_sequence == 1 | stop_sequence == 2, 0, lag(delay_minutes, 2)),
         lags3station = if_else(stop_sequence == 1 | stop_sequence == 2| stop_sequence == 3, 0, lag(delay_minutes, 3)),
         lags4station = if_else(stop_sequence == 1 | stop_sequence == 2| stop_sequence == 3| stop_sequence == 4, 0, lag(delay_minutes, 4)),
         lags5station = if_else(stop_sequence == 1 | stop_sequence == 2| stop_sequence == 3| stop_sequence == 4| stop_sequence == 5, 0, lag(delay_minutes, 5)),
         lags6station = if_else(stop_sequence == 1 | stop_sequence == 2| stop_sequence == 3| stop_sequence == 4| stop_sequence == 5| stop_sequence == 6, 0, lag(delay_minutes, 6)),
         lags7station = if_else(stop_sequence == 1 | stop_sequence == 2| stop_sequence == 3| stop_sequence == 4| stop_sequence == 5 | stop_sequence ==6 | stop_sequence == 7, 0, lag(delay_minutes, 7)),
         lags8station = if_else(stop_sequence == 1 | stop_sequence == 2| stop_sequence == 3| stop_sequence == 4| stop_sequence == 5| stop_sequence == 6| stop_sequence == 7| stop_sequence == 8 , 0, lag(delay_minutes, 8))
         )
```

```{r evaluate_time_lags, echo=FALSE, fig.height=4, fig.width=8}
selected_columns <- merged_dataset_station[, c("delay_minutes", "lag15min","lag30min","lag45min","lag1h",                       "lag1h15min","lag1h30min","lag1h45min","lag2h","lag2h15min","lag2h30min","lag2h45min","lag3h","week")]
cor_delay_all_time <- cor(selected_columns, use = "complete.obs")["delay_minutes", -1]%>%
  as.data.frame()%>%rename(cor_score = '.')

plotData.lag_time <-
  filter(as.data.frame(merged_dataset_station), week == 43) %>%
  dplyr::select(lag15min,lag30min,lag45min,lag1h,                       lag1h15min,lag1h30min,lag1h45min,lag2h,lag2h15min,lag2h30min,lag2h45min,lag3h, delay_minutes) %>%
  gather(Variable, Value, -delay_minutes) %>%
  mutate(Variable = fct_relevel(Variable,"lag15min","lag30min","lag45min","lag1h",                       "lag1h15min","lag1h30min","lag1h45min","lag2h","lag2h15min","lag2h30min","lag2h45min","lag3h"))

correlation.lag_time <-
  group_by(plotData.lag_time, Variable) %>%
    summarize(correlation = round(cor(Value, delay_minutes, use = "complete.obs"), 2))

ggplot(plotData.lag_time, aes(Value,delay_minutes))+
  geom_point(size = 0.1) +
  geom_text(data = correlation.lag_time, aes(label = paste("r =", round(correlation, 2))),
            x=-Inf, y=Inf, vjust = 1.5, hjust = -.1) +
  geom_smooth(method = 'lm', se=FALSE, color ="#2a9d8f")+
  facet_wrap(~Variable, ncol = 4, scales = 'free') +
  labs(title = "Delay minute from previous time as a function of spatial lags",
       subtitle = "One week in Oct, 2019") +
  mapTheme()
```

```{r evaluate_station_lags, echo=FALSE, fig.height=4, fig.width=8}
selected_columns <- merged_dataset_station[, c("delay_minutes", "lagsstation", "lags2station", "lags3station", "lags4station", "lags5station", "lags6station","lags7station", "lags8station","week")]
cor_delay_all_stations <- cor(selected_columns, use = "complete.obs")["delay_minutes", -1]%>%
  as.data.frame()%>%rename(cor_score = '.')

plotData.lag_station <-
  filter(as.data.frame(merged_dataset_station), week == 43) %>%
  dplyr::select(starts_with("lags"), delay_minutes) %>%
  gather(Variable, Value, -delay_minutes) %>%
  mutate(Variable = fct_relevel(Variable, "lagsstation", "lags2station", "lags3station", "lags4station", "lags5station", "lags6station","lags7station", "lags8station"))

correlation.lag_station <-
  group_by(plotData.lag_station, Variable) %>%
    summarize(correlation = round(cor(Value, delay_minutes, use = "complete.obs"), 2))

ggplot(plotData.lag_station, aes(Value,delay_minutes))+
  geom_point(size = 0.1) +
  geom_text(data = correlation.lag_station, aes(label = paste("r =", round(correlation, 2))),
            x=-Inf, y=Inf, vjust = 1.5, hjust = -.1) +
  geom_smooth(method = 'lm', se=FALSE, color ="#2a9d8f")+
  facet_wrap(~Variable, ncol = 3, scales = 'free') +
  labs(title = "Delay minute from previous stations as a function of spatial lags",
       subtitle = "One week in Oct, 2019") +
  mapTheme()
```
Correlation Matrix - all variables
```{r}
merged_dataset_station <- merged_dataset_station%>%
  mutate(isbig_from = ifelse(From_city == 'big city',1,0),
         isbig_to = ifelse(To_city == 'big city',1,0),
         isweekday = ifelse(weekend == 'Weekday',1,0))
```

```{r}
cor_matrix <- merged_dataset_station %>%
  dplyr::select(delay_minutes,stop_sequence,distance,Temperature,Precipitation,Wind_Speed,from_inter,to_inter,isweekday,lag15min,lag30min,lag45min,lag1h,                       lag1h15min,lag1h30min,lag1h45min,lag2h,lag2h15min,lag2h30min,lag2h45min,lag3h,lagsstation,lags2station,lags3station, lags4station, lags5station, lags6station, lags7station, lags8station)

cor_matrix <- cor(cor_matrix, method = "pearson", use = "complete.obs")

corrplot(cor_matrix)
```

```{r train_test }
merged_dataset_model <- merged_dataset_station%>%
  filter(line != 'Atl. City Line')%>%
  mutate(hour = hour(interval60))
delay.Train <- filter(merged_dataset_model, week <= 42)
delay.Test <- filter(merged_dataset_model, week > 42)
```

```{r five_models }
reg1 <- 
  lm(delay_minutes ~  hour + dotw + Temperature,  data=delay.Train)

reg2 <- 
  lm(delay_minutes ~  from + to + dotw + Temperature,  data=delay.Train)

reg3 <- 
  lm(delay_minutes ~  from + to + hour + dotw + Temperature + Precipitation, 
     data=delay.Train)

reg4 <- 
  lm(delay_minutes ~  from + to +  hour + dotw + Temperature + Precipitation +
                   lag1h + lag2h +lag3h, 
     data=delay.Train)

reg5 <- 
  lm(delay_minutes ~  hour + weekend + Temperature + Precipitation + Wind_Speed + lag15min + lag30min + lag45min + lag1h + lag1h15min + lag1h30min + lag1h45min + lag2h + lag2h15min+lag2h30min+lag2h45min+lag3h + lagsstation + lags2station + lags3station+ lags4station+ lags5station+lags6station+ stop_sequence + line + to_inter + from_inter, 
     data=delay.Train)

reg6 <- 
  lm(delay_minutes ~  from + to + hour + weekend + Temperature + Precipitation + Wind_Speed + lag15min + lag30min + lag45min + lag1h + lag1h15min + lag1h30min + lag1h45min + lag2h + lag2h15min+lag2h30min+lag2h45min+lag3h + lagsstation + lags2station + lags3station+ lags4station+ lags5station+lags6station+ stop_sequence + line + to_inter + from_inter, 
     data=delay.Train)
```

```{r model error}
#dplyr::select(from,to,delay_minutes,weekend,line)%>%
delay.Test_5 <- delay.Test%>%
  mutate(pre_5 = predict(reg5, newdata = delay.Test),
         abosulte_error = abs(pre_5 - delay_minutes),
         MAE = mean(abosulte_error,na.rm = TRUE),
         sd_AE = sd(abosulte_error,na.rm = TRUE),
         per_error = (pre_5 - delay_minutes)/delay_minutes,
         per_error = ifelse(per_error == Inf,0,per_error),
         per_error = ifelse(per_error == -Inf,0,per_error))

#dplyr::select(from,to,delay_minutes,weekend,line)%>%
delay.Test_6 <- delay.Test%>%
  mutate(pre_6 = predict(reg6, newdata = delay.Test),
         abosulte_error = abs(pre_6 - delay_minutes),
         MAE = mean(abosulte_error,na.rm = TRUE),
         sd_AE = sd(abosulte_error,na.rm = TRUE),
         per_error = (pre_6 - delay_minutes)/delay_minutes,
         per_error = ifelse(per_error == Inf,0,per_error),
         per_error = ifelse(per_error == -Inf,0,per_error))

delay.Test_6%>%
  dplyr::select(interval60, from, delay_minutes, pre_6) %>%
  gather(Variable, Value, -interval60, -from) %>%
    group_by(Variable, interval60) %>%
    summarize(Value = mean(Value))%>%
    ggplot(aes(interval60, Value, colour=Variable)) + 
    geom_line(size = 1.1)+
      labs(title = "Predicted/Observed delay time series", subtitle = "NJ; A test set of 2 weeks",  x = "Hour", y= "Mean Delay") +
     theme_minimal()
```

```{r error visualization}
temp <- delay.Test_5 %>% 
  group_by(from)%>%
  summarise(mean_ae = mean(abosulte_error),
            mean_pe = mean(per_error))%>%
  left_join(stop,by=c('from'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  dplyr::select(from,mean_ae,geometry)%>%
  mutate(mod = 'Reg5')

temp2 <- delay.Test_6 %>% 
  group_by(from)%>%
  summarise(mean_ae = mean(abosulte_error),
            mean_pe = mean(per_error))%>%
  left_join(stop,by=c('from'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  dplyr::select(from,mean_ae,geometry)%>%
  mutate(mod = 'Reg6')

temp3 <- rbind(temp,temp2)

ggplot() +
    geom_sf(data = NJTracts, color = 'grey') + 
    geom_sf(data = temp3, aes(color = mean_ae,size = mean_ae)) +
    scale_colour_viridis(direction = -1,discrete = FALSE, option = "D") +
    labs(title = "Mean Abosulte Error in Stop Prediction") +
    facet_wrap(~mod)+
    mapTheme()
```

```{r error visualization-weekend}
temp <- delay.Test_6 %>% 
  group_by(from,weekend)%>%
  summarise(mean_ae = mean(abosulte_error),
            mean_pe = mean(per_error))%>%
  left_join(stop,by=c('from'='STATION_ID'))%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)

ggplot() +
    geom_sf(data = NJTracts, color = 'grey') + 
    geom_sf(data = temp, aes(color = mean_ae)) +
    scale_colour_viridis(direction = -1,discrete = FALSE, option = "D") +
    labs(title = "Mean Abosulte Error Comaprison in Weekend") +
    facet_wrap(~weekend)+mapTheme()
```

```{r}
temp <- delay.Test_6 %>% 
  group_by(line)%>%
  summarise(mean_ae = mean(abosulte_error),
            mean_pe = mean(per_error))%>%
  left_join(line,by=c('line'='LINE_NAME'))

ggplot() +
    geom_sf(data = NJTracts, color = 'grey') + 
    geom_sf(data = temp,aes(color = mean_ae, geometry = geometry))+
    scale_colour_viridis(direction = -1,discrete = FALSE, option = "D") +
    labs(title = "Mean Abosulte Error in Line")+mapTheme()
```

```{r}
fitControl <- trainControl(method = "cv", number = 10)
set.seed(825)

reg.cv <- 
  train(delay_minutes ~ from + to + hour + weekend + Temperature + Precipitation + Wind_Speed + lag15min + lag30min + lag45min + lag1h + lag1h15min + lag1h30min + lag1h45min + lag2h + lag2h15min+lag2h30min+lag2h45min+lag3h + lagsstation + lags2station + lags3station+ lags4station+ lags5station+lags6station+ stop_sequence + line + to_inter + from_inter, delay.Train, 
        method = "lm", trControl = fitControl, na.action = na.pass)

ggplot(reg.cv$resample, aes(x=MAE)) + 
  geom_histogram(color='white',fill="orange",bins=100)+
  scale_x_continuous(limits=c(0,150000),breaks=c(25000,50000,75000,100000,125000,150000))+
  scale_y_continuous(breaks=c(0,2,4,6,8,10))
```